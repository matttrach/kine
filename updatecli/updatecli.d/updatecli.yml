---
name: "Bump Go version in updatecli"
scms:
  kine:
    kind: "github"
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      username: "{{ requiredEnv .github.username }}"
      token: '{{ requiredEnv .github.token }}'
      owner: "{{ .kine.org }}"
      repository: "{{ .kine.repo }}"
      branch: "{{ .kine.branch }}"
  go:
    kind: "github"
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      username: "{{ requiredEnv .github.username }}"
      token: '{{ requiredEnv .github.token }}'
      owner: "{{ .go.org }}"
      repository: "{{ .go.repo }}"
      branch: "{{ .go.branch }}"

sources:
  latestGoTag:
    name: "Get latest Go 1.x tag"
    kind: "gittag"
    scmid: "go"
    spec:
      versionfilter:
        kind: "regex"
        pattern: 'go1\.[2-9][0-9]*\.\d$' # >= go1.20 < go2
    transformers:
      - trimprefix: "go"

conditions:
  updatecliWorkflowUsesLatestGoVersion:
    name: "If go version in workflow config doesn't match latest go tag"
    kind: "yaml"
    scmid: "kine"
    sourceid: latestGoTag
    spec:
      file: ".github/workflows/updatecli.yml"
      key: jobs.updatecli.steps[1].with.go-version
    failwhen: true

targets:
  updatecliWorkflowGoVersion:
    name: "Update go version in workflow to match latest go tag"
    kind: "yaml"
    scmid: "kine"
    sourceid: latestGoTag
    spec:
      file: ".github/workflows/updatecli.yml"
      key: jobs.updatecli.steps[1].with.go-version

actions:
  # create a pull request which is not allowed to automerge
  # ths commit message is automatically generated
  github:
    kind: "github"
    scmid: "kine"
    spec:
      automerge: false
      draft: false
      mergemethod: squash
      parent: false # this would allow for making a PR to an upstream fork

